---
layout: post
title: Android GCM (Google Cloud Messaging)：Server Side
date: '2013-07-01T15:48:00.000+08:00'
author: Ken Yang
tags:
- gcm
- Google
- android
modified_time: '2013-07-01T16:35:51.858+08:00'
thumbnail: http://1.bp.blogspot.com/---a7cZjAEeA/UdEpYeGYlxI/AAAAAAAAE30/f0KjxHr6zuI/s72-c/Screen+Shot+2013-07-01+at+3.06.20+PM.png
blogger_id: tag:blogger.com,1999:blog-866973865356001297.post-5845220494066906185
blogger_orig_url: http://blog.kenyang.net/2013/07/android-gcm-google-cloud.html
---

GCM (Google Cloud Messaging）其實就是<a href="http://blog.kenyang.net/2011/12/android-c2dm.html">C2DM</a> 的前身，<br />先前就有寫過四篇文章來講解C2DM，<br />分別有：<br />第一篇在講<a href="http://blog.kenyang.net/2011/12/android-c2dm.html">參數說明</a> （舊版C2DM）<br />第二篇在講<a href="http://blog.kenyang.net/2011/12/android-c2dm_22.html">流程說明</a> （舊版C2DM）<br />第三篇在講<a href="http://blog.kenyang.net/2012/03/android-c2dm-sever.html"><span class="s1">server</span>端的實作</a> （舊版C2DM）<br />第四篇在講<a href="http://blog.kenyang.net/2012/03/android-c2dm-android.html"><span class="s1">android</span>端的實作</a> （舊版C2DM）<br /><br /><br /><br />其實新版的GCM和C2DM只有些微的差別，因此在migrate時只需要小小變化，<br /><br />甚至更為方便！<br />除了方便以外，而GCM多了一項新功能，<br />就是讓你的server可以與Google Server建立一個persistent TCP connection，<br />其目的就是為了讓你使用XMPP，而此Server稱作Cloud Connection Server（CCS)<br /><br /><br />當然我們也可以用傳統的HTTP Server，而這兩者個差異，可以看這篇<a href="http://developer.android.com/google/gcm/ccs.html">文章</a>．<br /><br /><br />而本篇文章主要是告訴大家如何implement server side，<br />以及怎麼和Google Server做溝通！<br />這裡語言主要會以Python為主！<br />然後web-framework是使用flask，<br />web server是nginx+uwsgi<br /><br />如果要看Android Client Side，請至（<a href="http://blog.kenyang.net/2013/07/android-gcm-google-cloud_1.html">http://blog.kenyang.net/2013/07/android-gcm-google-cloud_1.html</a>）<br /><br /><br />在開始之前，還要告訴大家GCM有個最方便的地方，<br />還記得C2DM在傳資料給Google Server時，需要帶一個header<br />而這個header必須儲存Google Client Login的auth token．<br />我一直覺得這非常非常之愚蠢！！<br />等於我如果要做到automation，我還要有一套機制去使用Google Client Login API去login google，實在太不方便！<br />但現在不用了！！！<br />取而代之的是用API Key！（這才是根本之道啊）<br /><br />至於怎麼申請API Key呢？<br /><ol><li>請先來到<a href="https://code.google.com/apis/console/">Google API Console</a></li><li>點選左邊的Services</li><li>找到Google Cloud Messaging for Android</li><li>把它打開</li><li>接著點選左邊API Access</li><li>點選按鈕『Create new Server Key』</li><li>點選按鈕『Create』</li><li>接著就會看到下圖中的API key，請記起來！</li></ol><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/---a7cZjAEeA/UdEpYeGYlxI/AAAAAAAAE30/f0KjxHr6zuI/s1104/Screen+Shot+2013-07-01+at+3.06.20+PM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/---a7cZjAEeA/UdEpYeGYlxI/AAAAAAAAE30/f0KjxHr6zuI/s1600/Screen+Shot+2013-07-01+at+3.06.20+PM.png" /></a></div><br /><br /><br /><br />接著要開始寫Server Side<br />Server Side分為兩個角色！<br /><ol><li>Android Device會傳送自己本身的registration id上來給Server，此時Server必須儲存此id</li><li>把data和id一併送到Google Server去，這時候Google Server就會自動push data至對應到該id的device上</li></ol><br /><br />首先是接收registration id的部分！因為我偷懶，我收到id以後就寫到一個file裡面去<br />正規做法應該是存在database之類的，但我這邊為了方便，所以先存在一個file裡去！<br /><br /><pre class="brush: python">@app.route("/storeRegId",methods=['GET'])<br />def storeRegId():                                                                                                          <br />    id = request.args.get('id') <br />    <br />    with open("regIdList","w") as f:<br />        f.write("%s" % id) <br /><br />    return 'id %s' % id<br /></pre><br />接著就是傳送data給Google Server的部分！<br />請注意把下面的API_KEY換成您自己的！<br />這個範例傳送的資料會有兩筆，分別是last name以及first name！<br />當然你可以增加或者減少！反正就是JSON format！<br /><br /><pre class="brush: python">@app.route("/send")                                                                                                        <br />def send():<br /><br />    # remember place your API Key<br />    API_KEY = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'<br /><br />    params = {}<br />        <br />    # put the data you want to send to device <br />    params['data']={ 'last name': 'yang','first name': 'ken'}<br /><br />    # get registration id, this registration id will be mapped to a device.<br />    f = open ("regIdList","r")<br />    regId = f.read() <br />    f.close()<br /><br />    params['registration_ids']=[regId]<br />    params = json.JSONEncoder().encode(params)<br /><br /><br />    headers = { "Content-type":     "application/json",<br />                "Authorization":    "key="+API_KEY}<br /><br />    conn = httplib.HTTPSConnection("android.googleapis.com")  <br /><br />    # method,url,body,header<br />    conn.request('POST','/gcm/send', params,headers)<br />    res = conn.getresponse() <br /><br />    conn.close()  <br />    result = {'msg':res.status}<br />    return jsonify(result)<br /><br /></pre><br /><br /><br />這樣就完成了Server side的部分！<br />將在下一篇教大家怎麼implement Android part！<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
---
layout: post
title: Android In-app billing (IAB) version 3
date: '2014-10-16T16:19:00.001+08:00'
author: Ken Yang
tags:
- iab
- Google
- android
modified_time: '2014-10-16T16:21:44.463+08:00'
thumbnail: http://4.bp.blogspot.com/-juHaFVdxJtE/VD9hQRnFPSI/AAAAAAAAFhI/8k_Ou03qUOU/s72-c/Screen%2BShot%2B2014-10-16%2Bat%2B2.08.36%2BPM.png
blogger_id: tag:blogger.com,1999:blog-866973865356001297.post-5454036553995380620
blogger_orig_url: http://blog.kenyang.net/2014/10/android-in-app-billing-iab-version-3.html
---

<div style="font-size: 15px; line-height: 22px;"><br />這篇要講怎麼整合IAB，<br />IAB就是讓user可以在你的app中購買商品．<br /><br /><span style="color: #e06666; font-size: 18px;">1. Download billing service library</span>  <br /><br />開啓Android SDK Manager，<br />找到最下面的 Extras，安裝Google Play Billing Library，<br />安裝完以後，在您Android SDK 目錄中會有該 Library，位置如下：<br /><pre class="brush: java">$SDK_PATH/extras/google/play_billing/in-app-billing-v03<br /></pre><br /><span style="color: #e06666; font-size: 18px;">2. Create new package</span>  <br /><br />接著在這一步要在你的project下建立一個新的package，<br />點選 File &gt; New &gt; Package, 名稱為com.android.vending.billing<br /><br /><span style="color: #e06666; font-size: 18px;">3. Copy necessary files</span>  <br /><br />在這一步驟要複製一些必要的檔案至project中，<br />1. IInAppBillingService.aidl，<br />&nbsp;&nbsp;&nbsp;&nbsp;這個檔案放在$SDK_PATH/extras/google/play_billing/in-app-billing-v03底下，<br />&nbsp;&nbsp;&nbsp;&nbsp;把IInAppBillingService.aidl，複製到我們剛剛create的package中，<br />2. *.java<br />&nbsp;&nbsp;&nbsp;&nbsp;Google幫我們寫好了很多的wrapper，可以很方便地使用IAB，<br />&nbsp;&nbsp;&nbsp;&nbsp;這wrapper會幫我們處理一些bind service的動作，<br />&nbsp;&nbsp;&nbsp;&nbsp;透過這些wrapper可以輕易地整合IAB，<br />&nbsp;&nbsp;&nbsp;&nbsp;檔案路徑如下：<br /><pre class="brush: java">$SDK_PATH/extras/google/play_billing/samples/TrivialDrive/src/com/example/android<br />/trivialdrivesample/util<br /></pre>&nbsp;&nbsp;&nbsp;&nbsp;把這底下所有的.java複製到你的project當中，並且要把package名稱改成自己的<br /><br /><span style="color: #e06666; font-size: 18px;">4. Add permission</span>  <br /><br />接著要在AndroidManifest.xml中加入下面這個權限，<br /><pre class="brush: java">&lt;uses-permission android:name=&quot;com.android.vending.BILLING&quot;&gt;<br />&lt;/uses-permission&gt;</pre><br /><span style="color: #e06666; font-size: 18px;">5. Upload apk</span>  <br /><br />因為要購買一個商品，這商品在新増之前，<br />你一定要有一個apk是有BILLING權限的，<br />否則是不能新增一個商品．<br />所以在這步驟要先上傳上去，你可以上傳以後再把它變成draft就好，<br />當然！你也可以通通寫完code再丟上去測試．<br /><br /><span style="color: #e06666; font-size: 18px;">6. Add product</span>  <br /><br />上傳apk以後，接著就可以去developer console新增product了，<br />1. 先到自己的developer console <br />2. 點選自己的app <br />3. 點選左邊的In-app Products <br />4. 點選Add new product<br />5. 輸入Product ID（這id等等code裡面會用到）<br />6. 最後填寫product的資訊<br /><br /><span style="color: #e06666; font-size: 18px;">7. Get public key</span>  <br /><br />由於在跟Google Play溝通時，<br />需要一把public key，<br />這把key一樣在developer console上，<br />1. 先到自己的developer console <br />2. 點選自己的app <br />3. 點選左邊的Services &amp; APIs<br />key就會在畫面之中，如下圖！<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-juHaFVdxJtE/VD9hQRnFPSI/AAAAAAAAFhI/8k_Ou03qUOU/s1600/Screen%2BShot%2B2014-10-16%2Bat%2B2.08.36%2BPM.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-juHaFVdxJtE/VD9hQRnFPSI/AAAAAAAAFhI/8k_Ou03qUOU/s1600/Screen%2BShot%2B2014-10-16%2Bat%2B2.08.36%2BPM.png" height="164" width="640" /></a></div><br /><br /><br /><span style="color: #e06666; font-size: 18px;">8. Implement</span>  <br /><br /><span style="color: #e06666; font-size: 18px;">8-1. Setup</span>  <br /><br />首先要先setup IabHelper，<br />在setup時就要把剛剛哪組public_key帶進去，<br />但由於Google有強烈的建議，不要直接hard code public key，<br />至少要用個xor encrypt的方式，或者用拆解字串的方式存放public key，<br />xor encrypt就是你先用xor去encrypt你的public key，<br />之後把encrypt過後的public key放在你的project中，<br />要用的時候再拿出來decrypt，decrypt完以後，應該就會是原先的public key了，<br />接著再判斷一下那組public key是否有包含“某部份”真正public key，<br />有的話才真的是你的public key，<br /><br /><pre class="brush: java">    private IabHelper mHelper;<br />    @Override<br />    public void onCreate(Bundle savedInstanceState) {<br /><br />        String base64EncodedPublicKey = xorDecrypt(PUBLIC_KEY, "key_password");<br /><br />        if (!base64EncodedPublicKey<br />                .contains("eFESRE6ijsRAp3TgWhY1zDwWwo1EqxQgt+f")) {<br />            throw new RuntimeException("This is not my key");<br />        }<br /><br />        mHelper = new IabHelper(this, base64EncodedPublicKey);<br /><br />        mHelper.startSetup(new IabHelper.OnIabSetupFinishedListener() {<br />            public void onIabSetupFinished(IabResult result) {<br />                Log.d(TAG, "Setup finished.");<br />                if (!result.isSuccess()) {<br />                    Log.d(TAG, "Problem setting up In-app Billing: " + result);<br />                }<br /><br />                if (mHelper == null)<br />                    return;<br />                <br />            }<br />        });<br />    }<br /><br />    public static String xorDecrypt(String input, String key) {<br />        byte[] inputBytes = Base64.decode(input, Base64.DEFAULT);<br />        int inputSize = inputBytes.length;<br /><br />        byte[] keyBytes = key.getBytes();<br />        int keySize = keyBytes.length - 1;<br /><br />        byte[] outBytes = new byte[inputSize];<br />        for (int i = 0; i &lt; inputSize; i++) {<br />            outBytes[i] = (byte) (inputBytes[i] ^ keyBytes[i % keySize]);<br />        }<br />        return new String(outBytes);<br />    }<br /><br /></pre><span style="color: #e06666; font-size: 18px;">8-2 購買商品</span>  <br /><br />購買商品要透過launchPurchaseFlow， <br />launchPurchaseFlow有五個參數， <br />1. activity <br />2. product id，就是剛剛上面在developer console新增的那組 <br />3. request code，onActivityResult時會回傳回來 <br />4. listener，購買狀態的listener，用來接收購買成功與否 <br />5. string，可以是空的，可以想像成是補充說明的意思，一樣在購買之後會回傳回來 <br /><pre class="brush: java">    if (mHelper != null) {<br />        mHelper.launchPurchaseFlow(this,<br />                SKU_PREMIUM,<br />                10001,<br />                mPurchaseFinishedListener,<br />                "bGoa+V7g/yqDXvKRqq+JTFn4uQZbPiQJo4pf9RzJ");<br />    }<br /><br /><br />    IabHelper.OnIabPurchaseFinishedListener mPurchaseFinishedListener = new IabHelper.OnIabPurchaseFinishedListener() {<br />        public void onIabPurchaseFinished(IabResult result, Purchase purchase) {<br />            if (result.isFailure()) {<br />                Log.e(TAG, "Error purchasing: " + result);<br />                return;<br />            } else if (purchase.getSku().equals(SKU_PREMIUM)) {<br />                Toast.makeText(getApplicationContext(), "buy success",Toast.LENGTH_LONG).show();<br />                Log.d(TAG, "Success purchasing:");<br />            }<br />        }<br />    };<br /><br /><br /></pre><br /><span style="color: #e06666; font-size: 18px;">8-3 查詢是否有購買</span>   <br /><br />在購買成功以後，android會把購買的結果cache在機器上， <br />以便快速地查詢， 查詢要透過queryInventoryAsync， <br />queryInventoryAsync有二個參數， <br />1. 是否要query product detail（ex: price） <br />2. listener  <br />其實第一個參數不一定要， <br />但是當你在沒有網路的情況下， 你的request一定都會是fail， <br />以至於你無法判斷這個user是否有購買了商品，<br />且如果你加了第一個參數，你就無法得到商品的detail資訊． <br />所以使用者要自己衡量一下何時該用．  <br /><pre class="brush: java">    mHelper.queryInventoryAsync(false,mGotInventoryListener);<br />    QueryInventoryFinishedListener mGotInventoryListener = new QueryInventoryFinishedListener() {<br />        public void onQueryInventoryFinished(IabResult result, Inventory inventory) {<br /><br />            if (result.isFailure()) {<br />                // handle error here<br />            } else {<br />                // does the user have the premium upgrade?<br />                boolean mIsPremium = inventory.hasPurchase(SKU_PREMIUM);<br />                if (mIsPremium) {<br />                    Toast.makeText(getApplicationContext(), "buy",Toast.LENGTH_LONG).show();<br />                }else {<br />                    Toast.makeText(getApplicationContext(), "no buy",Toast.LENGTH_LONG).show();<br />                }<br />            }<br />        }<br />    };<br /></pre><span style="color: #e06666; font-size: 18px;">8-4 Error handling</span>   <br /><br />最後一步驟，如果你launchPurchaseFlow了第一次，然後取消！ <br />隨即馬上launchPurchaseFlow第二次，絕對會crash， <br />原因是因為在onActivityResult中要做點處理， <br />我覺得這很tricky，因為在官網上並沒有提到！ <br />是去看他的example code才發現的！ <br />最後也要記得destroy這個helper．  <br /><pre class="brush: java">    @Override<br />    protected void onActivityResult(int requestCode, int resultCode, Intent data) {<br />        Log.d(TAG, "onActivityResult handled by IABUtil.1");<br />        // Pass on the activity result to the helper for handling<br />        if (mHelper!=null &amp;&amp; !mHelper.handleActivityResult(requestCode, resultCode, data)) {<br />            Log.d(TAG, "onActivityResult handled by IABUtil.2");<br />            // not handled, so handle it ourselves (here's where you'd<br />            // perform any handling of activity results not related to in-app<br />            // billing...<br />            super.onActivityResult(requestCode, resultCode, data);<br />        } else {<br />            Log.d(TAG, "onActivityResult handled by IABUtil.");<br />        }<br />    }<br /><br />    @Override<br />    protected void onDestroy() {<br />        super.onDestroy();<br />        if (adView != null) {<br />            adView.destroy();<br />        }<br /><br />        if (mHelper != null)<br />            mHelper.dispose();<br />        mHelper = null;<br />    }<br /></pre><br /><br /><span style="color: #e06666; font-size: 18px;">9. Test</span>   <br /><br />要測試IBA真的是件麻煩的事情， <br />要做兩件事， <br />1. create test account <br />&nbsp;&nbsp;&nbsp;&nbsp;因為你用自己的developer account測，會永遠無法購買， '<br />&nbsp;&nbsp;&nbsp;&nbsp;會跟你說publisher cannot purchase this item. <br />&nbsp;&nbsp;&nbsp;&nbsp;所以要去到developer console中的setting裡面加一組test account， <br />2. Export Signed Application <br />&nbsp;&nbsp;&nbsp;&nbsp;因為你無法用debug key去build app， <br />&nbsp;&nbsp;&nbsp;&nbsp;用debug key build出來的app是無法測試的... <br />&nbsp;&nbsp;&nbsp;&nbsp;所以得用production key sign出來的app才可以測試． <br />&nbsp;&nbsp;&nbsp;&nbsp;接著再把sign好的apk裝在手機上就可以測試了！         <br /></div><br /><br /><br /><br />
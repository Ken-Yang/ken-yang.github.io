---
layout: post
title: Android C2DM (四)：實作之Android篇
date: '2012-03-25T21:02:00.000+08:00'
author: Ken Yang
tags:
- android
- c2dm
modified_time: '2013-07-01T16:35:01.982+08:00'
blogger_id: tag:blogger.com,1999:blog-866973865356001297.post-7671669399322171448
blogger_orig_url: http://blog.kenyang.net/2012/03/android-c2dm-android.html
---

<span style="color: red; font-size: large;">這篇是舊版的，已經被deprecated，新版為GCM，新版的實作請看</span><br /><a href="http://blog.kenyang.net/2013/07/android-gcm-google-cloud_1.html"><span style="color: blue; font-size: large;">新版的Android篇</span></a><br /><br /><br /><br /><br /><span style="font-size: large;"><b>這篇主要在說明Android端的實作</b></span><br /><span style="font-size: large;"><b>第一篇在講<a href="http://blog.kenyang.net/2011/12/android-c2dm.html">參數說明</a></b></span><br /><span style="font-size: large;"><b>第二篇在講<a href="http://blog.kenyang.net/2011/12/android-c2dm_22.html">流程說明</a></b></span><br /><span style="font-size: large;"><b>第三篇在講<a href="http://blog.kenyang.net/2012/03/android-c2dm-sever.html">server端的實作</a></b></span><br /><br /><br />這篇主要會完成下列項目：<br /><ol style="background-color: white; color: #333333; font-family: Verdana, Arial, sans-serif; font-size: 13px; line-height: 16px; text-align: left;"><li>基本的manifest設定(加入receiver,permission)。</li><li>向C2DM 註冊。</li><li>接收自C2DM Sever回傳的registration id&nbsp;並傳送 Registration Id 到我們的Server，以及<span style="background-color: white;">接收Message</span></li></ol><div style="text-align: left;"><span style="color: #333333; font-family: Verdana, Arial, sans-serif; font-size: x-small;"><span style="line-height: 16px;"><br /></span></span></div><div style="text-align: left;"><span style="color: #333333; font-family: Verdana, Arial, sans-serif; font-size: x-small;"><span style="line-height: 16px;"><br /></span></span></div><div style="text-align: left;"><b style="background-color: white; color: #333333; font-family: Verdana, Arial, sans-serif; font-size: large; line-height: 16px;">【1. &nbsp;設定Manifest資料 】</b>&nbsp;<span style="color: #333333; font-family: Verdana, Arial, sans-serif; font-size: x-small;"><span style="line-height: 16px;"><br /></span></span></div><div style="text-align: left;"><span style="color: #333333; font-family: Verdana, Arial, sans-serif;"><span style="line-height: 16px;">這步驟，分了兩個部分!</span></span><br /><span style="color: #333333; font-family: Verdana, Arial, sans-serif;"><span style="line-height: 16px;">第一個就是要先加入一個receiver，</span></span><br /><span style="color: #333333; font-family: Verdana, Arial, sans-serif;"><span style="line-height: 16px;">記得下面的category android:name，</span></span><br /><span style="color: #333333; font-family: Verdana, Arial, sans-serif;"><span style="line-height: 16px;">裡面的value要改成自己的package name</span></span><br /><span style="color: #333333; font-family: Verdana, Arial, sans-serif;"><span style="line-height: 16px;">如下：</span></span></div><pre class="brush: xml">&lt;!-- 用來接收C2DM Server的receiver，且要有send的permssion --&gt;<br />        &lt;receiver android:name=".C2DMReceiver" android:permission="com.google.android.c2dm.permission.SEND"&gt;<br />            &lt;!-- Receive the actual message --&gt;<br />           &lt;intent-filter&gt;<br />               &lt;action android:name="com.google.android.c2dm.intent.RECEIVE" /&gt;<br />               &lt;category android:name="net.kenyang.android" /&gt;<br />           &lt;/intent-filter&gt;<br />           <br />           &lt;!-- Receive the registration id --&gt;<br />           &lt;intent-filter&gt;<br />               &lt;action android:name="com.google.android.c2dm.intent.REGISTRATION" /&gt;<br />               &lt;category android:name="net.kenyang.android" /&gt;<br />           &lt;/intent-filter&gt;<br />       &lt;/receiver&gt;<br /><br /></pre><br /><br />第二部分就是加入應有的permission，<br /><pre class="brush: xml">&lt;!-- 下面的net.kenyang記得要改成自己的package name --&gt;<br />&lt;permission   android:name="net.kenyang.android.permission.C2D_MESSAGE" android:protectionLevel="signature" /&gt;<br />&lt;uses-permission  android:name="net.kenyang.android.permission.C2D_MESSAGE" /&gt;<br />&lt;uses-permission  android:name="com.google.android.c2dm.permission.RECEIVE" /&gt;<br />&lt;uses-permission android:name="android.permission.INTERNET"/&gt;<br /><br /></pre><br /><b style="background-color: white; color: #333333; font-family: Verdana, Arial, sans-serif; font-size: large; line-height: 16px; text-align: left;"><br class="Apple-interchange-newline" />【2. &nbsp;向C2DM註冊 】</b><span style="text-align: left;">&nbsp;</span><br /><br />這一步驟就是啟動C2DM，並告訴C2DM要註冊，<br /><pre class="brush: java">Intent registrationIntent = new Intent("com.google.android.c2dm.intent.REGISTER");<br />registrationIntent.putExtra("app", PendingIntent.getBroadcast(SelectLoginMode.this, 0, new Intent(), 0)); // boilerplate<br />registrationIntent.putExtra("sender", "xxxxx@gmail.com"); // 記得這邊要填入當初你在第三篇註冊的MAIL<br />startService(registrationIntent);<br /><br /></pre><br /><b style="background-color: white; color: #333333; font-family: Verdana, Arial, sans-serif; font-size: large; line-height: 16px; text-align: left;">【3. &nbsp;接收與傳送資料 】</b><span style="text-align: left;">&nbsp;</span><br /><br />這一步驟就是寫一個receiver，<br />這個receiver會<br /><br /><ol><li>接收C2DM傳來的registration id，</li><li>也會接收C2DM傳來的message(這個message就是我們Server傳給C2DM的message)</li><li>並且將registration id傳送到我們第三篇實作的server上面去</li></ol><br /><br />我們先在receiver中寫一個函數將registration id傳送至我們第三篇實作的server上面去，<br />server只要收到，就會傳送資料到C2DM上!<br /><pre class="brush: java">private void fnRegistrationDone(final String strRegistrationId){<br />  try{<br />   Thread thread = new Thread(new Runnable() {<br />    <br />    @Override<br />    public void run() {<br />     HttpURLConnection conn = (HttpURLConnection) new URL("http://c2dm.kenyang.net/registration").openConnection();<br />     conn.setDoOutput(true);  <br />     conn.setUseCaches(false);  <br />     conn.setRequestMethod("GET");  // 因為在GAE上面的servlet，我是用get method<br />     conn.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");  <br />     conn.setRequestProperty("Content-Length", strRegistrationId.getBytes().length); // 告訴c2dm要傳送的資料長度<br />      <br />     // 送出資料<br />     OutputStream out = conn.getOutputStream();  <br />     out.write(strRegistrationId.getBytes());  <br />     out.close();  <br />      <br />     conn.fnClose();<br />     // 到這，一個註冊就完成，接著就是等著收資料<br />          <br />    }<br />   });<br />   thread.start();<br /><br />  }catch (Exception e) {<br />  }<br />  <br /> }<br /><br /></pre><br /><br />接著開始寫接收資料(registration_id, message)的code，如下：<br /><pre class="brush: java">@Override<br /> public void onReceive(Context context, Intent intent) {<br />  <br />  // 接收到C2DM的訊息<br />  if (intent.getAction().equals("com.google.android.c2dm.intent.REGISTRATION")) {<br />      <br />   String strRegistrationId = intent.getStringExtra("registration_id"); <br />   // 如果註冊失敗<br />      if (intent.getStringExtra("error") != null) {<br />          <br />    Log.d("Ken.yang", "c2dm registration fail");<br />    <br />   // Registration 成功<br />      } else if (strRegistrationId != null) {<br />       // 把registration_id傳到我們server(呼叫我們上面寫的函數)<br />       fnRegistrationDone(strRegistrationId);<br />        <br />      }<br />   <br />  } else if (intent.getAction().equals("com.google.android.c2dm.intent.RECEIVE")) {<br />   <br />   // 接收來自C2DM的MESSAGE，這message就是我們server傳給C2DM的 (可以看第三篇)<br />   if (intent.getExtras().containsKey("keyHello")){<br />    strValue =  intent.getExtras().getString("keyHello");<br />    Log.d("Ken.yang", "C2DM=== receive" + strValue);<br />   }<br />  }<br /> }<br /> <br /><br /></pre><br />完成上面步驟，就完成c2dm了！<br />也可以收到訊息了！！！！<br />因為我們<a href="http://blog.kenyang.net/2012/03/android-c2dm-sever.html">第三篇</a>server上傳送的訊息是fromKen，<br />所以這裡收到的也是fromKen!!<br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
---
layout: post
title: android 偵測 sdcard
date: '2010-08-19T19:17:00.000+08:00'
author: Ken Yang
tags:
- sdcard
- android
modified_time: '2010-11-06T16:52:32.351+08:00'
blogger_id: tag:blogger.com,1999:blog-866973865356001297.post-1441438010923937271
blogger_orig_url: http://blog.kenyang.net/2010/08/android-sdcard.html
---

最近在寫一些有關檔案的操作，<br /><br />要把檔案寫到sdcard裡去<br /><br />至於怎麼寫，這裡就不多說<br /><br />在寫檔之前，好的programmer一定要注意到防呆!<br /><br />就是detect sdcard的狀態<br /><br />是否有被mount上去?<br /><br />之前都直接寫一個function去取得目前sdcard的狀態，如下   <br /><pre class="brush: java"> private static final boolean fnIsSDcard(){<br />  return Environment.getExternalStorageState().equals(Environment.MEDIA_MOUNTED);  <br /> }<br /></pre><br /><br /><br />但是在我的需求中，這種寫法會有問題，<br /><br />因為我的檔案較大，在寫的過程中會耗費比較久的時間，<br /><br />如果在寫檔的過程中，sdcard被unmounted了! 很好，這個process會被killed掉!<br /><br />因為這是process中有參照到sdcard裡的位置，所以android os會強制kill掉!<br /><br />所以我就在想...sdcard有沒有event listener啊??<br /><br />但是沒有，所以我透過Service和BroadcastReceiver去實作<br /><br />首先先新增一個class，然後要extends Service，如下<br /><br /><br /><pre class="brush: java">public class serviceSDcard extends Service {<br /> @Override<br /> public IBinder onBind(Intent intent) {<br />  return null;<br /> }<br /><br /> @Override<br /> public void onStart(Intent intent, int startId) {<br />  //新增一個IntentFilter<br />  IntentFilter intentFilter = new IntentFilter();   <br />  //並且新增兩個action，告知此 service什麼時候的動作才要通知你<br />  intentFilter.addAction(Intent.ACTION_MEDIA_MOUNTED); //如果sdcard被掛載上去時通知<br />  intentFilter.addAction(Intent.ACTION_MEDIA_UNMOUNTED); //如果sdcard被卸載時通知<br />  intentFilter.addDataScheme("file"); <br />  intentFilter.addDataAuthority("*", null);<br />  registerReceiver(receiver, intentFilter);    //註冊一個BroadcastReceiver<br />  super.onStart(intent, startId);<br /> }<br /> private BroadcastReceiver receiver = new BroadcastReceiver() {<br />  <br />  @Override<br />  public void onReceive(Context context, Intent intent) {<br />   try {<br />    <br />    if (intent.getAction().equals(Intent.ACTION_MEDIA_UNMOUNTED)){<br />     //sdcard被卸載時的動作<br />     <br />    }else{<br />     //sdcard被掛載時的動作<br />    }<br />    <br />    <br />   } catch (Exception e) {<br />    Log.d("main", e.toString());<br />   }<br />  <br />  }<br /> };<br />}<br /></pre><br /><br /><br />一個Service就完成了，現在就要把Service啟動!<br /><br />在主要執行的activity中去startService();，如下<br /><br /><br /><pre class="brush: java">public class main extends Activity {<br />    @Override<br />    public void onCreate(Bundle savedInstanceState) {<br />        super.onCreate(savedInstanceState);<br />        setContentView(R.layout.main);<br />        Intent intent = new Intent(this,serviceSDcard.class);<br />        startService(intent);<br />    }<br />}<br /></pre><br /><br /><br /><br />這樣就完成啦! 記得要在manifest.xml中新增一個service喔!!如下:<br /><br /><br /><pre class="brush: java">&lt;service android:name=".serviceSDcard"&gt;&lt;/service&gt;<br /></pre><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />